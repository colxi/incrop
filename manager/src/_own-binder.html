<html>
<head>
	<script src="lib/system.js"></script>

</head>
<body>
	<div pg-view="layout"></div>
</body>


<script>
/* global SystemJS */
var pg = {
	Load : {
		adapter : function(a){
			return SystemJS.import('adapters/'+a+'.js');
		},
		view : function(view){
			let path = 'views/' + view + '.html';
			return new Promise(function(resolve){
				let done = false;
				let _html = new XMLHttpRequest();
				_html.overrideMimeType('text/html');
				_html.open('GET', path , true);
				_html.onload = _html.onreadystatechange = function (){
					if ( !done && (!this.readyState || this.readyState === 4) ) {
						done = true;
						resolve(_html.responseText);
						_html = _html.onload = _html.onreadystatechange = null;
					}
				};
				_html.onerror = function(){ resolve(false) };
				_html.send(null);
			});
		},
	},
	getScope  : function( e ) {
		console.log('getting scope of',e)
		while(true){
			if( e.hasAttribute('pg-adapter') && e.getAttribute('pg-adapter').trim() !== '' ) break;
			if(e.tagName === 'BODY' ) return _scopes;
			e = e.parentNode;
		}
		let s = e.getAttribute('pg-adapter');
		if( !_scopes.hasOwnProperty(s) ) _scopes[s] = {};
		return _scopes[s];
	},
	binder : async function( dom = document ){
		let elements = filterElements( dom );
		let e_count = elements.length;
		for(let i=0 ; i<e_count ; i++){
			let element = elements[i];
			switch( element.attribute ){
				case 'pg-view-content' :{
					break;
				}
				case 'pg-view' :{
					console.log('PG-VIEW');
					if(element.value === '') break;
					let html = await pg.Load.view(element.value);
					element.DOM.innerHTML = '<div pg-view-content>' + html + '</div>';
					await pg.binder( element.DOM.firstChild );
					break;
				}
				case 'pg-adapter':{
					console.log('PG-ADAPTER');
					if(element.value === '') break;
					let adapter = await pg.Load.adapter(element.value);
					if( !_scopes.hasOwnProperty(element.value) ) _scopes[element.value] = adapter;

					break;
				}
				//case 'pg-value':
			//		break;
				case 'pg-bind':
					console.log('PG-BIND',element.DOM);
					if(element.value === '') break;
					var adapter = pg.getScope( element.DOM );
					Object.defineProperty(adapter, element.value, {
						get: function() {
							return element.DOM;
						}
					});
					break;
				default :
					element.DOM.setAttribute(element.attribute.slice(3), element.value);
					element.DOM.removeAttribute( element.attribute );
			}
		}
	}
}


var $ = (selector)=>document.querySelectorAll(selector);

var _bindedElements  = new WeakMap();

var _scopes = {};


function getController( e ) {
	var path=[];
	while(true){
		if( e.hasAttribute('pg-adapter') ) path.push(e);
		if(e.tagName === 'BODY' ) break;
		e = e.parentNode;
	}
	path.reverse();

	let scope = _scopes;
	for(let i=0 ; i<path.length; i++){
		let controllerName = path[i].getAttribute('pg-adapter');
		if( !scope.hasOwnProperty( controllerName ) ) scope[ controllerName ] = {};
		scope = scope[ controllerName ];
	}
	return scope;
}

var filterElements = function( e = document ){
	// get all elements with a pomegranade attribute under the provided
	// parent element
	e = e.getElementsByTagName('*');
	const l = [];
	// iterate over all elements
	let e_count = e.length;
	for (let i = 0; i < e_count; i++){
		// iterate over all element attributes
		let a_count = e[i].attributes.length;
		for (let a = 0; a < a_count; a++) {
			let n = e[i].attributes[a].name;
			let v = e[i].attributes[a].value;
			if( /^pg-.+/.test( n ) ) l.push( {DOM: e[i], attribute: n , value : v.trim() } );
		}
	}
	return l;
};




pg.binder(  )



</script>
</html>
